<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Singularity &mdash; CRG Course - Containers: Docker and Singularity. October 2022  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
    <link rel="canonical" href="https://biocorecrg.github.io/CoursesCRG_Containers_Nextflow_May_2022/singularity.html" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            CRG Course - Containers: Docker and Singularity. October 2022
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="containers.html">Containers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">CRG Course - Containers: Docker and Singularity. October 2022</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Singularity</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/singularity.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="singularity">
<span id="singularity-page"></span><h1>Singularity<a class="headerlink" href="#singularity" title="Permalink to this heading"></a></h1>
<section id="introduction-to-singularity">
<h2>Introduction to Singularity<a class="headerlink" href="#introduction-to-singularity" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><dl class="simple">
<dt>Focus:</dt><dd><ul>
<li><p>Reproducibility to scientific computing and the high-performance computing (HPC) world.</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>Origin: Lawrence Berkeley National Laboratory. Later spin-off: Sylabs</p></li>
<li><p>Version 1.0 -&gt; 2016</p></li>
<li><p>More information: <a class="reference external" href="https://en.wikipedia.org/wiki/Singularity_(software)">https://en.wikipedia.org/wiki/Singularity_(software)</a></p></li>
</ul>
<section id="singularity-architecture">
<h3>Singularity architecture<a class="headerlink" href="#singularity-architecture" title="Permalink to this heading"></a></h3>
<a class="reference internal image-reference" href="images/singularity_architecture.png"><img alt="images/singularity_architecture.png" src="images/singularity_architecture.png" style="width: 800px;" /></a>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Strengths</p></th>
<th class="head"><p>Weaknesses</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>No dependency of a daemon</p></td>
<td><p>At the time of writing only good support in Linux</p></td>
</tr>
<tr class="row-odd"><td><p>Can be run as a simple user</p></td>
<td><p>Mac experimental. Desktop edition. Only running</p></td>
</tr>
<tr class="row-even"><td><p>Avoids permission headaches and hacks</p></td>
<td><p>For some features you need root account (or sudo)</p></td>
</tr>
<tr class="row-odd"><td><p>Image/container is a file (or directory)</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>More easily portable</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>Two types of images: Read-only (production)</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>Writable (development, via sandbox)</p></td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>Trivia</strong></p>
<p>Nowadays, there may be some confusion since there are two projects:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/apptainer/singularity">Apptainer Singularity</a></p></li>
<li><p><a class="reference external" href="https://sylabs.io/singularity/">Sylabs Singularity</a></p></li>
</ul>
<p>They “forked” in 2021. So far they share most of the codebase, but eventually this could be different, and software might have different functionality.</p>
<p>The former is already “End Of Life” and its development continues named as <a class="reference external" href="http://apptainer.org/">Apptainer</a>, under the support of the Linux Foundation.</p>
</section>
</section>
<section id="container-registries">
<h2>Container registries<a class="headerlink" href="#container-registries" title="Permalink to this heading"></a></h2>
<p>Container images, normally different versions of them, are stored in container repositories.</p>
<p>These repositories can be browser or discovered within, normally public, container registries.</p>
<section id="docker-hub">
<h3>Docker Hub<a class="headerlink" href="#docker-hub" title="Permalink to this heading"></a></h3>
<p>It is the first and most popular public container registry (which provides also private repositories).</p>
<ul class="simple">
<li><p><a class="reference external" href="https://hub.docker.com">Docker Hub</a></p></li>
</ul>
<p>Example:</p>
<p><a class="reference external" href="https://hub.docker.com/r/biocontainers/fastqc">https://hub.docker.com/r/biocontainers/fastqc</a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">singularity build fastqc-0.11.9_cv7.sif docker://biocontainers/fastqc:v0.11.9_cv7</span>
</pre></div>
</div>
</section>
<section id="biocontainers">
<h3>Biocontainers<a class="headerlink" href="#biocontainers" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://biocontainers.pro">Biocontainers</a></p></li>
</ul>
<p>Website gathering Bioinformatics focused container images from different registries.</p>
<p>Originally Docker Hub was used, but now other registries are preferred.</p>
<p>Example: <a class="reference external" href="https://biocontainers.pro/tools/fastqc">https://biocontainers.pro/tools/fastqc</a></p>
<section id="via-quay-io">
<h4>Via quay.io<a class="headerlink" href="#via-quay-io" title="Permalink to this heading"></a></h4>
<p><a class="reference external" href="https://quay.io/repository/biocontainers/fastqc">https://quay.io/repository/biocontainers/fastqc</a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">singularity build fastqc-0.11.9.sif docker://quay.io/biocontainers/fastqc:0.11.9--0</span>
</pre></div>
</div>
</section>
<section id="via-galaxy-project-prebuilt-images">
<h4>Via Galaxy project prebuilt images<a class="headerlink" href="#via-galaxy-project-prebuilt-images" title="Permalink to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">singularity pull --name fastqc-0.11.9.sif https://depot.galaxyproject.org/singularity/fastqc:0.11.9--0</span>
</pre></div>
</div>
<p>Galaxy project provides all Bioinformatics software from the BioContainers initiative as Singularity prebuilt images. If download and conversion time of images is an issue, this might be the best option for those working in the biomedical field.</p>
<p>Link: <a class="reference external" href="https://depot.galaxyproject.org/singularity/">https://depot.galaxyproject.org/singularity/</a></p>
</section>
</section>
<section id="running-and-executing-containers">
<h3>Running and executing containers<a class="headerlink" href="#running-and-executing-containers" title="Permalink to this heading"></a></h3>
<p>Once we have some image files (or directories) ready, we can run processes.</p>
<section id="singularity-shell">
<h4>Singularity shell<a class="headerlink" href="#singularity-shell" title="Permalink to this heading"></a></h4>
<p>The straight-forward exploratory approach is equivalent to <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span> <span class="pre">-ti</span> <span class="pre">biocontainers/fastqc:v0.11.9_cv7</span> <span class="pre">/bin/shell</span></code> but with a more handy syntax.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">singularity shell fastqc-0.11.9.sif</span>
</pre></div>
</div>
<p>Move around the directories and notice how the isolation approach is different in comparison to Docker. You can access most of the host filesystem.</p>
</section>
<section id="singularity-exec">
<h4>Singularity exec<a class="headerlink" href="#singularity-exec" title="Permalink to this heading"></a></h4>
<p>That is the most common way to execute Singularity (equivalent to <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">exec</span></code>). That would be the normal approach in a HPC environment.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">singularity exec fastqc-0.11.9.sif fastqc</span>
</pre></div>
</div>
<p>Test a processing of a file from <em>testdata</em> directory:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">singularity exec fastqc-0.11.9_cv7.sif fastqc B7_input_s_chr19.fastq.gz</span>
</pre></div>
</div>
</section>
<section id="singularity-run">
<h4>Singularity run<a class="headerlink" href="#singularity-run" title="Permalink to this heading"></a></h4>
<p>This executes runscript from recipe definition (equivalent to <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span></code>). Not so common for HPC uses. More common for instances (servers).</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">singularity run fastqc-0.11.9.sif</span>
</pre></div>
</div>
</section>
<section id="environment-control">
<h4>Environment control<a class="headerlink" href="#environment-control" title="Permalink to this heading"></a></h4>
<p>By default Singularity inherits a profile environment (e.g., PATH environment variable). This may be convenient in some circumstances, but it can also lead to unexpected problems when your own environment clashes with the default one from the image.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">singularity shell -e fastqc-0.11.9.sif</span>
<span class="go">singularity exec -e fastqc-0.11.9.sif fastqc</span>
<span class="go">singularity run -e fastqc-0.11.9.sif</span>
</pre></div>
</div>
<p>Compare <code class="docutils literal notranslate"><span class="pre">env</span></code> command with and without -e modifier.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">singularity exec fastqc-0.11.9.sif env</span>
<span class="go">singularity exec -e fastqc-0.11.9.sif env</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="singularity-advanced-aspects">
<h2>Singularity advanced aspects<a class="headerlink" href="#singularity-advanced-aspects" title="Permalink to this heading"></a></h2>
<section id="bind-paths-aka-volumes">
<h3>Bind paths (aka volumes)<a class="headerlink" href="#bind-paths-aka-volumes" title="Permalink to this heading"></a></h3>
<p>Paths of host system mounted in the container</p>
<ul class="simple">
<li><p>Default ones, no need to mount them explicitly (for 3.6.x): <code class="docutils literal notranslate"><span class="pre">`$HOME`</span></code> , <code class="docutils literal notranslate"><span class="pre">`/sys:/sys`</span></code> , <code class="docutils literal notranslate"><span class="pre">`/proc:/proc`</span></code>, <code class="docutils literal notranslate"><span class="pre">`/tmp:/tmp`</span></code>, <code class="docutils literal notranslate"><span class="pre">`/var/tmp:/var/tmp`</span></code>, <code class="docutils literal notranslate"><span class="pre">`/etc/resolv.conf:/etc/resolv.conf`</span></code>, <code class="docutils literal notranslate"><span class="pre">`/etc/passwd:/etc/passwd`</span></code>, and <code class="docutils literal notranslate"><span class="pre">`$PWD`</span></code>  <a class="reference external" href="https://apptainer.org/docs/user/main/bind_paths_and_mounts.html">Ref</a></p></li>
</ul>
<p>For others, need to be done explicitly (syntax: host:container)</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">mkdir datatest</span>
<span class="go">touch datatest/testout</span>
<span class="go">singularity shell -e -B ./datatest:/scratch fastqc-0.11.9.sif</span>
<span class="go">&gt; touch /scratch/testin</span>
<span class="go">&gt; exit</span>
<span class="go">ls -l testdir</span>
</pre></div>
</div>
<section id="exercise">
<h4>Exercise<a class="headerlink" href="#exercise" title="Permalink to this heading"></a></h4>
<p>Using the 2 fastq available files, process them outside and inside a mounted directory using fastqc.</p>
<details>
<summary><a>Suggested solution</a></summary><div class="highlight-console notranslate"><div class="highlight"><pre><span></span># Let&#39;s create a dummy directory
mkdir datatest

# Let&#39;s copy contents of testdata in that directory

singularity exec fastqc.sif fastqc datatest/*fastq.gz

# Check you have some HTMLs there. Remove them
rm datatest/*html

# Let&#39;s use shell
singularity shell fastqc.sif
&gt; cd datatest
&gt; fastqc *fastq.gz
&gt; exit

# Check you have some HTMLs there. Remove them
singularity exec -B ./datatest:/scratch fastqc.sif fastqc /scratch/*fastq.gz

# What happens here!
singularity exec -B ./datatest:/scratch fastqc.sif bash -c &#39;fastqc /scratch/*fastq.gz&#39;
</pre></div>
</div>
</details></section>
</section>
<section id="singularity-tips">
<h3>Singularity tips<a class="headerlink" href="#singularity-tips" title="Permalink to this heading"></a></h3>
<section id="troubleshooting">
<h4>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">singularity --help</span>
</pre></div>
</div>
</section>
<section id="fakeroot">
<h4>Fakeroot<a class="headerlink" href="#fakeroot" title="Permalink to this heading"></a></h4>
<p>Singularity permissions are an evolving field. If you don’t have access to <code class="docutils literal notranslate"><span class="pre">sudo</span></code>, it might be worth considering using <strong>–fakeroot/-f</strong> parameter.</p>
<ul class="simple">
<li><p>More details at <a class="reference external" href="https://apptainer.org/docs/user/main/fakeroot.html">https://apptainer.org/docs/user/main/fakeroot.html</a></p></li>
</ul>
</section>
<section id="singularity-cache-directory">
<h4>Singularity cache directory<a class="headerlink" href="#singularity-cache-directory" title="Permalink to this heading"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$HOME/.singularity
</pre></div>
</div>
<ul class="simple">
<li><p>It stores cached images from registries, instances, etc.</p></li>
<li><p>If problems may be a good place to clean. When running <code class="docutils literal notranslate"><span class="pre">sudo</span></code>, $HOME is /root.</p></li>
</ul>
</section>
<section id="global-singularity-configuration">
<h4>Global singularity configuration<a class="headerlink" href="#global-singularity-configuration" title="Permalink to this heading"></a></h4>
<p>Normally at <code class="docutils literal notranslate"><span class="pre">/etc/singularity/singularity.conf</span></code> or similar (e.g preceded by <code class="docutils literal notranslate"><span class="pre">/usr/local/</span></code>)</p>
<ul class="simple">
<li><p>It can only be modified by users with administration permissions</p></li>
<li><p>Worth noting <code class="docutils literal notranslate"><span class="pre">bind</span> <span class="pre">path</span></code> lines, which point default mounted directories in containers</p></li>
</ul>
</section>
<section id="note-version-at-the-crg">
<h4>NOTE: Version at the CRG<a class="headerlink" href="#note-version-at-the-crg" title="Permalink to this heading"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">module</span> <span class="n">use</span> <span class="o">/</span><span class="n">software</span><span class="o">/</span><span class="k">as</span><span class="o">/</span><span class="n">el7</span><span class="mf">.2</span><span class="o">/</span><span class="n">EasyBuild</span><span class="o">/</span><span class="n">CRG</span><span class="o">/</span><span class="n">modules</span><span class="o">/</span><span class="nb">all</span>
<span class="c1">#module spider singularity -&gt; This search for modules with that name</span>
<span class="c1">#module spider apptainer</span>
<span class="c1">#module load Singularity/3.7.0</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">Apptainer</span><span class="o">/</span><span class="mf">1.0.3</span>
</pre></div>
</div>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, CRG.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>